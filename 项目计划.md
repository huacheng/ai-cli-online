# 项目计划: CLI-Online (Claude Code Web Chat)

> 状态: **待确认**
> 最后更新: 2026-02-05
> 版本: v2 (根据用户反馈修正核心定位)

---

## 一、项目背景与痛点

### 1.1 用户痛点

使用 SSH 登录远端服务器执行 Claude Code 时存在以下问题：

| 痛点 | 描述 |
|------|------|
| **网络不稳定** | SSH 连接经常断开，需要重新登录 |
| **会话丢失** | 与 Claude 的对话上下文丢失，需手动找回 |
| **临时方案不够好** | screen/tmux 只是简陋地解决了会话恢复，仍需手动重连 |
| **配置复杂** | 对于小白用户，screen/tmux 的配置和操作门槛较高 |

### 1.2 目标用户

- 在远程服务器上使用 Claude Code 的开发者
- 网络环境不稳定的用户
- 希望简化操作流程的小白用户

---

## 二、解决方案 (v2 修正版)

### 2.1 核心定位修正

> ⚠️ **重要澄清**: 本项目 **不是** 简单的终端投射 (xterm.js)，而是 **对话式 AI 助手界面**

**用户交互方式：**
```
用户输入: "帮我在 ~/ 目录下创建项目文件夹 cli-online, 并初始化 git 仓库"
     │
     ▼
后台: Claude Code 执行该任务
     │
     ▼
界面: 显示执行状态 → 显示执行结果 → 任务完成
```

### 2.2 架构设计

```
┌─────────────────────────────────────────────────────────────┐
│                      用户浏览器                              │
│              ┌────────────────────────┐                     │
│              │    💬 对话式聊天界面     │                     │
│              │  (类似 ChatGPT/WebChat) │                     │
│              └────────────────────────┘                     │
└─────────────────────┬───────────────────────────────────────┘
                      │ WebSocket (自动重连)
                      │ - 发送: 用户自然语言指令
                      │ - 接收: 执行状态 + 结果
                      ▼
┌─────────────────────────────────────────────────────────────┐
│                   Web Server (Daemon)                        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │  对话管理    │  │ Claude调度  │  │  会话持久化         │  │
│  │  - 历史记录  │  │ - 任务队列  │  │  - 对话存储         │  │
│  │  - 上下文    │  │ - 状态追踪  │  │  - 断点恢复         │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
└─────────────────────┬───────────────────────────────────────┘
                      │ 调用 Claude Code CLI
                      │ (非交互模式 / PTY 解析)
                      ▼
┌─────────────────────────────────────────────────────────────┐
│                    Claude Code CLI                           │
│              (执行实际任务: 文件操作、代码编写等)              │
└─────────────────────────────────────────────────────────────┘
```

### 2.3 核心功能

| 功能 | 描述 |
|------|------|
| **对话式交互** | 用自然语言描述任务，无需学习 CLI 命令 |
| **实时状态反馈** | 显示 Claude Code 正在执行什么操作 |
| **结果展示** | 清晰展示任务执行结果 (成功/失败/变更内容) |
| **会话持久化** | 服务端保存完整对话历史，断连后自动恢复 |
| **自动重连** | 网络断开后浏览器自动重连，无需手动操作 |
| **Daemon 模式** | 后端服务持续运行，一次启动长期使用 |
| **多对话并行** | (进阶) 在一个任务 Tab 下同时运行多个对话，2xN 瀑布式布局 |
| **成果文档落地** | (后期) 将讨论成果保存为文档，支持迭代研究 |

### 2.4 多对话并行架构 (进阶功能)

**使用场景**：一个大的特性开发任务，拆分为多个子任务并行执行

```
┌─────────────────────────────────────────────────────────────────┐
│  📁 特性任务 Tab: 用户认证模块开发                                │
├─────────────────────────────────────────────────────────────────┤
│                        2 x N 瀑布式布局                          │
│                                                                 │
│  ┌─────────────────────────┐  ┌─────────────────────────┐      │
│  │ 💬 对话1: 设计 API 接口  │  │ 💬 对话2: 编写单元测试   │      │
│  │ ⚡ 执行中...            │  │ ✅ 已完成                │      │
│  │ > 正在生成接口定义...   │  │ > 已创建 auth.test.ts   │      │
│  │                         │  │                         │      │
│  │ [展开详情]              │  │ [展开详情]              │      │
│  └─────────────────────────┘  └─────────────────────────┘      │
│                                                                 │
│  ┌─────────────────────────┐  ┌─────────────────────────┐      │
│  │ 💬 对话3: 实现登录逻辑   │  │ 💬 对话4: 编写文档       │      │
│  │ ⚡ 执行中...            │  │ 🕐 等待中...            │      │
│  │ > 正在编辑 login.ts... │  │                         │      │
│  │                         │  │                         │      │
│  │ [展开详情]              │  │ [展开详情]              │      │
│  └─────────────────────────┘  └─────────────────────────┘      │
│                                                                 │
│  [+ 新建对话]                                                   │
├─────────────────────────────────────────────────────────────────┤
│  任务进度: 2/4 完成 ████████░░░░░░░░ 50%                        │
└─────────────────────────────────────────────────────────────────┘
```

**核心概念**：

| 概念 | 说明 |
|------|------|
| **任务 (Task)** | 一个大的特性开发目标，如 "用户认证模块" |
| **对话 (Conversation)** | 任务下的子任务，独立的 Claude Code 会话 |
| **并行执行** | 多个对话可同时运行，各自独立的 Claude 进程 |
| **瀑布布局** | 2 列 x N 行，响应式平铺展示 |

**后端支持**：

```
┌─────────────────────────────────────────────────────────────────┐
│                        后端会话管理器                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Task: "用户认证模块"                                            │
│  ├── Conversation 1 ──→ Claude Code 进程 ① (PID: 1234)         │
│  ├── Conversation 2 ──→ Claude Code 进程 ② (PID: 1235)         │
│  ├── Conversation 3 ──→ Claude Code 进程 ③ (PID: 1236)         │
│  └── Conversation 4 ──→ Claude Code 进程 ④ (PID: 1237)         │
│                                                                 │
│  资源限制: 最多 N 个并行进程 (可配置)                             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2.4 交互示例

```
┌──────────────────────────────────────────────────────────────┐
│  CLI-Online - Claude Code Web Assistant                      │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  👤 你: 帮我在 ~/ 目录下创建项目文件夹 cli-online,            │
│        并初始化 git 仓库                                      │
│                                                              │
│  🤖 Claude Code:                                             │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ ⚡ 正在执行...                                          │ │
│  │                                                        │ │
│  │ 1. 创建目录 ~/cli-online                               │ │
│  │    ✅ 完成                                              │ │
│  │                                                        │ │
│  │ 2. 初始化 git 仓库                                      │ │
│  │    ✅ 完成                                              │ │
│  │                                                        │ │
│  │ 📁 已创建:                                              │ │
│  │    ~/cli-online/                                       │ │
│  │    ~/cli-online/.git/                                  │ │
│  │                                                        │ │
│  │ ✨ 任务完成!                                            │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
│  👤 你: 现在帮我创建一个 README.md 文件，                     │
│        描述这是一个 Claude Code Web 客户端项目                │
│                                                              │
│  🤖 Claude Code:                                             │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ ⚡ 正在执行...                                          │ │
│  │ ...                                                    │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
├──────────────────────────────────────────────────────────────┤
│  [输入你的任务...]                              [发送]        │
└──────────────────────────────────────────────────────────────┘
```

---

## 三、与 OpenClaw 的对比分析 (修正版)

### 3.1 核心相似点

现在来看，本项目与 OpenClaw 的 **WebChat** 模式非常相似：

| 方面 | OpenClaw WebChat | 本项目 (CLI-Online) |
|------|------------------|---------------------|
| 交互方式 | 对话式聊天 | 对话式聊天 |
| 会话管理 | ✅ | ✅ |
| 断连恢复 | ✅ | ✅ |
| Daemon 模式 | ✅ | ✅ |

### 3.2 关键差异

| 方面 | OpenClaw | 本项目 (CLI-Online) |
|------|----------|---------------------|
| **AI 执行引擎** | 自有 Pi agent (直接调 API) | **Claude Code CLI** |
| **执行能力** | 受限于 Pi agent 实现 | **完整的 Claude Code 能力** (文件编辑、代码生成、工具调用等) |
| **多渠道** | 12+ 渠道 | 仅 Web |
| **复杂度** | 高 (完整平台) | 低 (专注单一场景) |
| **服务器文件访问** | 需要配置 | **原生支持** (Claude Code 直接操作) |

### 3.3 Pi Agent vs Claude Code CLI 详解

这是理解两个项目核心区别的关键：

#### OpenClaw 的 Pi Agent

```
用户消息 → OpenClaw Gateway → Pi Agent → Claude API
                                  │
                                  ├─ 自己实现的工具系统
                                  ├─ 自己实现的文件操作
                                  ├─ 自己实现的代码执行
                                  └─ 自己实现的上下文管理
```

**Pi Agent 是 OpenClaw 团队自己开发的 AI agent 运行时**：
- 直接调用 Claude API / OpenAI API 等原始接口
- 自己实现了工具调用逻辑 (browser, canvas, nodes 等)
- 自己实现了会话管理、消息路由
- 是一个**从头构建**的 agent 框架

**局限性**：
- 能力受限于 Pi Agent 自己实现了多少功能
- 文件编辑能力需要 OpenClaw 团队自己实现
- 代码理解能力需要自己实现
- 更新 Claude 新功能需要 OpenClaw 团队跟进开发

#### Claude Code CLI (Anthropic 官方)

```
用户消息 → Claude Code CLI → Claude API
                   │
                   ├─ 官方实现的完整工具系统
                   │   ├─ Read (读取文件)
                   │   ├─ Write (写入文件)
                   │   ├─ Edit (编辑文件)
                   │   ├─ Bash (执行命令)
                   │   ├─ Glob/Grep (搜索)
                   │   └─ ... 20+ 工具
                   │
                   ├─ 官方实现的代码理解
                   ├─ 官方实现的上下文管理
                   └─ 官方实现的安全沙箱
```

**Claude Code CLI 是 Anthropic 官方开发的完整 AI 编程助手**：
- 已内置完整的文件操作能力 (Read/Write/Edit)
- 已内置代码理解和分析能力
- 已内置 Bash 命令执行
- 已内置 Git 操作
- 已内置多文件重构能力
- **开箱即用**，功能由 Anthropic 官方维护更新

#### 核心对比

| 方面 | OpenClaw Pi Agent | Claude Code CLI |
|------|-------------------|-----------------|
| 开发者 | OpenClaw 社区 | Anthropic 官方 |
| 工具能力 | 自己实现，有限 | 官方实现，完整 |
| 文件编辑 | 需自己实现 | ✅ 内置 Read/Write/Edit |
| 代码理解 | 基础 | ✅ 深度理解 |
| Bash 执行 | 需配置 | ✅ 内置沙箱 |
| Git 操作 | 需自己实现 | ✅ 内置支持 |
| 多文件重构 | 困难 | ✅ 原生支持 |
| 功能更新 | 依赖社区 | Anthropic 官方维护 |

#### 本项目的选择

```
用户 (浏览器)
     │
     │ "帮我重构这个函数并添加单元测试"
     ▼
CLI-Online Server (我们开发)
     │
     │ 调用 Claude Code CLI
     ▼
Claude Code CLI (Anthropic 官方)
     │
     │ 已有完整能力，直接执行
     ▼
完成任务 (文件修改、测试创建等)
```

**我们的策略**：不重新发明轮子，而是**封装和代理** Claude Code CLI
- 前端：我们开发对话式 Web 界面
- 后端：我们开发 WebSocket 服务 + 会话管理
- 执行引擎：**直接使用 Claude Code CLI**，享受其完整能力

**这意味着**：
- 你在网页上说 "帮我重构这个函数"
- 后台调用的是完整的 Claude Code CLI
- Claude Code 有能力做到的，本项目就能做到
- 未来 Anthropic 更新 Claude Code，本项目自动受益

### 3.4 为什么不直接用 OpenClaw？

1. **执行引擎不同**: OpenClaw 的 Pi agent 能力有限，Claude Code CLI 能力完整
2. **能力差异**: Claude Code CLI 有官方实现的文件编辑、代码理解、工具调用
3. **维护性**: Claude Code CLI 由 Anthropic 官方维护，功能更新有保障
4. **部署场景**: 你需要的是在服务器上执行 Claude Code 任务，而不是多渠道消息助手

### 3.4 可借鉴的部分

从 OpenClaw 可以借鉴：
- Gateway WebSocket 架构设计
- 会话管理和持久化机制
- WebChat UI 设计模式

---

## 四、技术方案

### 4.1 调用 Claude Code 的方式

有两种可行方案：

**方案 A: 非交互模式 (推荐 MVP)**
```bash
claude --message "帮我创建 cli-online 目录并初始化 git" --print
```
- 优点: 简单，输出结构化
- 缺点: 无法实时显示进度

**方案 B: PTY + 输出解析**
```javascript
const pty = require('node-pty');
const claude = pty.spawn('claude', [], { ... });
claude.onData(data => {
  // 解析输出，提取状态和结果
  // 实时推送到前端
});
```
- 优点: 可实时显示执行进度
- 缺点: 需要解析 Claude Code 的输出格式

**建议**: MVP 先用方案 A，后续迭代加入方案 B 的实时反馈

### 4.2 技术栈

```
后端:
  - Node.js / TypeScript
  - Express / Fastify (HTTP 服务)
  - ws / Socket.io (WebSocket)
  - node-pty (可选, 用于实时输出)
  - SQLite / JSON 文件 (会话存储)

前端:
  - React / Vue (推荐 React)
  - Tailwind CSS (快速样式)
  - Markdown 渲染 (显示代码/结果)
  - WebSocket 客户端
```

### 4.3 会话恢复机制

```
1. 服务端存储:
   - 对话历史 (用户消息 + Claude 响应)
   - Claude Code 会话 ID (用于 --resume)
   - 任务执行状态

2. 断连恢复:
   - 前端重连后，请求历史对话
   - 服务端返回完整对话记录
   - 如有进行中的任务，继续推送状态

3. Claude Code 会话恢复:
   - 使用 claude --resume <session-id>
   - 保持上下文连续性
```

---

## 五、项目阶段规划 (v3 修正版)

### 阶段一: MVP (最小可行产品)

**目标**: 基本可用的单对话界面

| 任务 | 描述 |
|------|------|
| 后端服务框架 | Express + WebSocket 服务 |
| Claude Code 调用 | 非交互模式 (--message --print) |
| 对话存储 | JSON 文件存储对话历史 |
| 前端聊天界面 | React + 简单的消息发送/接收界面 |
| **工作目录导航** | **显示/切换当前工作目录** |
| 基础认证 | Token 认证保护 |

**工作目录导航设计**:

```
┌─────────────────────────────────────────────────────────────┐
│  📁 /home/ubuntu/projects/my-app                    [切换]  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  💬 对话区域                                                 │
│  ...                                                        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

功能：
- 显示当前工作目录路径
- 点击 [切换] 可选择/输入新目录
- Claude Code 在该目录下执行任务
- 目录变更后持久化保存

**交付物**: 能在网页发送任务，显示 Claude Code 执行结果，明确知道工作目录

### 阶段二: 会话持久化 + 实时反馈

**目标**: 断连恢复 + 实时显示执行进度

| 任务 | 描述 |
|------|------|
| 完整会话存储 | 保存对话历史到文件 |
| 会话恢复 | 重连时加载历史对话 |
| 自动重连 | 前端 WebSocket 断线自动重连 |
| Claude 会话恢复 | 利用 Claude Code 的 `--resume` |
| PTY 集成 | 实时获取 Claude Code 输出 |
| 流式显示 | 实时显示执行进度和状态 |

**交付物**: 断连恢复 + 实时看到 Claude Code 执行过程

### 阶段三: 多对话并行

**目标**: 一个任务 Tab 下多个对话并行执行

| 任务 | 描述 |
|------|------|
| 任务管理 | 创建/管理特性开发任务 |
| 多对话支持 | 任务下创建多个独立对话 |
| 并行执行 | 多个 Claude Code 进程同时运行 |
| 2xN 瀑布布局 | 对话卡片瀑布式平铺展示 |
| 进度总览 | 任务级别的进度统计 |

**交付物**: 可在一个任务下同时运行多个子任务对话

### 阶段四: 高级功能 (后期)

| 任务 | 描述 |
|------|------|
| 成果文档落地 | 将讨论成果导出为 Markdown |
| 任务模板 | 预设常用任务模板 |
| 对话依赖 | 对话间的执行顺序依赖 |
| 会话历史搜索 | 搜索历史对话内容 |
| UI 美化 | 现代化界面设计 |

---

## 六、项目配置 (已确认)

### 6.1 技术选型

| 项目 | 决定 | 说明 |
|------|------|------|
| 前端框架 | ✅ **React** | 多对话并行需要复杂状态管理 |
| 后端框架 | ✅ **Node.js + Express** | WebSocket + Claude Code 调用 |
| 数据存储 | ✅ **JSON 文件** | MVP 先用，后续可迁移 |
| HTTPS | 先 HTTP | 部署时加 HTTPS |

### 6.2 功能配置

| 项目 | 决定 |
|------|------|
| 用户模式 | ✅ **单用户** |
| 并行对话数 | ✅ **最多 4 个** |
| 实时反馈 | 阶段二实现 |

### 6.3 环境信息

| 项目 | 值 |
|------|-----|
| 服务器 | ✅ **Ubuntu** |
| Claude Code | 已安装 |
| Node.js | 待确认版本 |

---

## 七、下一步行动

**全部确认完成！**

- [x] 核心定位：对话式界面 + Claude Code CLI 作为执行引擎
- [x] 前端框架：React
- [x] 后端框架：Node.js + Express + WebSocket
- [x] 用户模式：单用户
- [x] 并行对话：最多 4 个
- [x] 服务器：Ubuntu
- [x] 进阶功能：多对话并行 + 2xN 瀑布布局

**准备开始阶段一 MVP 实现！**
